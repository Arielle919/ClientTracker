#!/usr/bin/env ruby
require_relative 'lib/environment'
require_relative 'lib/argument_parser'
require_relative 'lib/interactions'

# Router:
class ClientTracker
  include Interactions
  attr_reader :options

  def initialize
    @options = ArgumentParser.parse
    Environment.environment = @options[:environment] || "production"
    @options.delete(:environment)
  end

  def main
    Environment.connect_to_database

    command = options.delete(:command)
    if options[:command] == "start"
      show_directions()
    elsif options[:command] == "search"
      search_clients()
    elsif options[:command] == "add"
      add_clients()
    elsif options[:command] == "list"
      list_clients()
    elsif options[:command] == "delete"
      delete_rows()
    elsif options[:command] == "client appointments"
      list_appointments()
    elsif options[:command] == "need appointments"
      need_appointments()
    elsif options[:command] == "task incomplete"
      task_processing()
    elsif options[:command] == "task complete"
      task_complete()
    elsif options[:command] == "client tasks"
      list_task()
    elsif options[:command] == "edit"
      edit_client()
    end
  end

  def show_directions()
    directions = ["WELCOME TO CLIENT TRACKER",
      "Client Tracker is a command application where you can create, edit, and save your clients.",
      "INSTRUCTIONS:",
      "CREATE CLIENT: ruby clienttracker add 'client name' --appointment mm/dd/yyyy --tasks 'client task' --need_appointment yes --task_completed no",
      "EDIT CLIENT: ruby clienttracker edit 'client name' --appointment mm/dd/yyyy --tasks 'client task' --need_appointment yes --task_completed no",
      "DELETE CLIENT: ruby clienttracker delete --id 01",
      "LIST ALL CLIENTS ruby clienttracker 'list'",
      "SEARCH CLIENT: ruby clienttracker search",
      "LIST CLIENTS THAT NEED APPOINTMENT: ruby clienttracker 'need appointments'",
      "LIST APPOINTMENTS FOR 1 CLIENT: ruby clienttracker 'client appointments' --name 'client name'",
      "LIST INCOMPLETE TASK: ruby clienttracker 'task incomplete'",
      "LIST COMPLETE TASK: ruby clienttracker 'task complete'",
      "LIST TASK FOR 1 CLIENT: ruby clienttracker 'client tasks' --name 'client name'"]
    directions.each_slice(1) { |line|
    puts line.join(" ").center(100)
    }
  end

  def search_clients()
    search_term = ask("What do you want to search for?")
    search_clients_for(search_term)
  end

  def add_clients()
    error_messages = ArgumentParser.validate(options)
    if error_messages.empty?
      client = Client.new(options)
      client.save
      puts "A client named #{client.name}, #{client.appointment}, #{client.task}, #{client.need_appointment}, #{client.completed_task} was created."
    else
      puts error_messages.join(" ")
    end
  end

  def list_clients()
    puts "All Clients:"
    show_clients = Client.all
    columns = ["ID", "NAME", "APPOINTMENT", "TASK"]
    columns.each_slice(6) { |line|
      puts line.join(" ".center(8))
    }
    show_clients.each_slice(1) { |line|
    puts line.join(" --"+" ")
    }
  end

  def delete_rows()
    if client = Client.find_by(options[:id])
      client.destroy
      puts "client '#{client.id}' named: '#{client.name}' was deleted."
    else
      puts "Client Id doesn't exist!!!"
    end
  end
#   user = User.find_by(name: 'David')
# user.destroy

  #   def delete_rows()
  #   if client = Client.find(options[:id])
  #     delTasks = @database.execute("DELETE FROM tasks WHERE id = '#{client.id}'")
  #     delApps = @database.execute("DELETE FROM appointments WHERE id = '#{client.id}'")
  #     delClients = @database.execute("DELETE FROM clients WHERE id = '#{client.id}'")
  #     delApps
  #     delClients
  #     delTasks
  #       puts "client '#{client.id}' named: '#{client.name}' was deleted."
  #   else
  #     puts "Client Id doesn't exist!!!"
  #   end
  # end

  def list_appointments()
    appointment_name = options[:name]
    puts "All Appointments for #{appointment_name}:"
    results_appointments = Client.where(client.name = '#{appointment_name}')
    # results_appointments = @database.execute("SELECT appointments.id, appointments.name, appointments.appointment FROM appointments WHERE name = '#{appointment_name}' ORDER by name ASC")
    columns = ["ID", "NAME", "APPOINTMENT"]
    columns.each_slice(3) { |line|
      puts line.join(" ".center(10))
    }
    results_appointments.each_slice(1) { |apps|
        puts apps.join(" -- "+" ")
    }
  end

  def need_appointments()
    puts "Clients Need Appointments:"
    columns = ["ID", "NAME"]
    columns.each_slice(2) { |line|
      puts line.join(" ".center(5))
    }
    needApp = Client.where(client.need_appointment = 'yes')
    # needApp = @database.execute("SELECT appointments.id, appointments.name FROM appointments WHERE appointments.needAppointment = 'yes'")
    needApp.each_slice(1) { |needapps|
        puts needapps.join(" -- "+" ")
    }
  end

  def task_processing()
    puts "Incomplete Task:"
    uncomTask = Client.where(client.completed_task = 'no')
    # uncomTask = @database.execute("SELECT tasks.id, tasks.name, tasks.appointment, tasks.tasks FROM tasks WHERE tasks.taskCompleted = 'no'")
    columns = ["ID", "NAME", "APPOINTMENT", "TASK"]
    columns.each_slice(4) { |line|
      puts line.join(" ".center(10))
    }
    uncomTask.each_slice(1) { |task|
        puts task.join(" -- "+" ")
    }
  end

  def task_complete()
    puts "Task Complete:"
    comTask = Client.where(client.completed_task = 'yes')
    # comTask = @database.execute("SELECT tasks.id, tasks.name, tasks.appointment, tasks.tasks FROM tasks WHERE tasks.taskCompleted = 'yes'")
    columns = ["ID", "NAME", "APPOINTMENT", "TASK"]
    columns.each_slice(4) { |line|
      puts line.join(" ".center(9))
    }
    comTask.each_slice(1) { |task|
        puts task.join(" -- "+" ")
    }
  end

  def list_task()
    task_name = options[:name]
    puts "All Tasks for #{task_name}:"
    results_tasks = Client.where(client.name = '#{task_name}')
    # results_tasks = @database.execute("SELECT tasks.id, tasks.name, tasks.appointment, tasks.tasks FROM tasks WHERE name = '#{task_name}' ORDER by name ASC")
    columns = ["ID", "NAME", "APPOINTMENT", "TASK"]
    puts columns
    puts results_tasks
    # columns.each_slice(4) { |line|
    #   puts line.join(" ".center(10))
    # }
    # results_tasks.each_slice(1) { |task|
    #     puts task.join(" -- "+" ")
    # }
  end

  def edit_client()
    if client = Client.find_by(id: options[:id])
      client.update(options)
      puts "Client #{client.id} is now named #{client.name}, #{client.appointment}, #{client.task}, #{client.need_appointment}, #{client.task_completed}"
    else
      puts "Client #{options[:id]} couldn't be found."
    end
  end

end

clienttracker = ClientTracker.new()
clienttracker.main()